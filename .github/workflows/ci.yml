# SPDX-FileCopyrightText: 2025 Alicipy <dev@stefankraus.org>
#
# SPDX-License-Identifier: Apache-2.0

name: "Integration checks"

on:
  schedule:
    - cron: "31 4 * * *"
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-test:
    name: "Build and test coffeecaller"
    runs-on: ubuntu-latest
    env:
      ZEPHYR_SDK_INSTALL_DIR: ./zephyr-sdk
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
        with:
          path: coffeecaller

      - name: Setup Zephyr workspace
        uses: zephyrproject-rtos/action-zephyr-setup@c125c5ebeeadbd727fa740b407f862734af1e52a #v1.0.9
        with:
          app-path: coffeecaller
          toolchains: arm-zephyr-eabi:x86_64-zephyr-elf
          sdk-version: 0.17.4

      - name: Build all sample integrations
        run: |
          west twister --integration -T ./coffeecaller/samples/

      - name: Check CoffeeCaller application is building
        run: |
          west twister --integration -T ./coffeecaller/applications

      - name: Run all tests
        run: |
          west twister \
            --outdir twister-out --inline-logs \
            --coverage --coverage-basedir ./coffeecaller \
            -T ./coffeecaller/tests

      - name: Upload Twister Reports
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #v4.6.2
        with:
          name: twister-reports
          path: |
            twister-out/coverage/index.html
            twister-out/twister.json
            twister-out/twister.xml
            twister-out/twister_report.xml

  publish-test-results:
    name: "Publish Tests Results"
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      checks: write
      pull-requests: write
    if: (!cancelled())
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 #v5.0.0
        with:
          path: artifacts

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@3a74b2957438d0b6e2e61d67b05318aa25c9e6c6 #v2.20.0
        with:
          files: "artifacts/**/twister_report.xml"
